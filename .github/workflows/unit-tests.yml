name: Execute Unit Tests

on:
  pull_request:
    branches: [ main ]
  release:
    types: [published, created]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: ${{ github.event_name == 'release' && fromJSON('["ubuntu-latest", "windows-latest", "macos-latest"]') || fromJSON('["ubuntu-latest"]') }}
        python-version: ['3.12']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov flake8

    - name: Lint with flake8
      run: |
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Test with pytest
      run: |
        pytest --cov=. --cov-report=xml --cov-report=term --junitxml=junit.xml -v

    - name: Generate coverage report
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12'
      run: |
        python -m coverage report --format=markdown > coverage_report.md
        python -m coverage report

    - name: Upload coverage to Codecov
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: Install xml2js
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12' && always()
      run: npm install xml2js

    - name: Comment PR with test results
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.12' && always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const { parseStringPromise } = require('xml2js');
          
          let testSummary = '## ðŸ§ª Test Results\n\nTest results not available';
          let coverageReport = 'Coverage report not available';
          
          // Read and parse test results
          try {
            const testResults = fs.readFileSync('junit.xml', 'utf8');
            const result = await parseStringPromise(testResults);
            
            if (result && result.testsuites) {
              const testsuite = result.testsuites.testsuite[0].$;
              const tests = testsuite.tests;
              const failures = testsuite.failures;
              const errors = testsuite.errors;
              const time = parseFloat(testsuite.time).toFixed(2);
              const passed = tests - failures - errors;
              
              testSummary = `## ðŸ§ª Test Results
          - **Total Tests**: ${tests}
          - **âœ… Passed**: ${passed}
          - **âŒ Failed**: ${failures}
          - **âš ï¸ Errors**: ${errors}
          - **â±ï¸ Duration**: ${time}s`;
            }
          } catch (error) {
            console.log('Error reading test results:', error.message);
          }
          
          // Read coverage report
          try {
            coverageReport = fs.readFileSync('coverage_report.md', 'utf8');
          } catch (error) {
            console.log('Error reading coverage report:', error.message);
          }
          
          const comment = `${testSummary}
          
          ## ðŸ“Š Code Coverage
          
          ${coverageReport}
          
          ---
          *Tests run on: Ubuntu Latest, Python 3.12*
          *Workflow: ${context.workflow} â€¢ Run #${context.runNumber}*`;
          
          // Find existing comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('ðŸ§ª Test Results')
          );
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: comment
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
          }